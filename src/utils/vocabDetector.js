// 智能生词识别系统 v2
// 使用词典验证，确保只识别真正的词汇

import { VOCABULARY_DATABASE } from '../data/vocabDefinitions';

// ============================================
// 常用中文词汇表（用于验证分词结果）
// ============================================
const VALID_WORDS = new Set([
    // 从释义库导入
    ...Object.keys(VOCABULARY_DATABASE),

    // 常用双字词
    '我们', '你们', '他们', '她们', '自己', '大家', '别人', '什么', '怎么', '这样', '那样',
    '可以', '应该', '必须', '可能', '需要', '希望', '相信', '知道', '认识', '了解', '明白',
    '喜欢', '讨厌', '害怕', '担心', '高兴', '难过', '生气', '着急', '放心', '小心',
    '开始', '结束', '继续', '停止', '完成', '准备', '计划', '决定', '选择', '放弃',
    '学习', '工作', '生活', '休息', '运动', '旅游', '购物', '吃饭', '睡觉', '起床',
    '时间', '地方', '东西', '事情', '问题', '答案', '办法', '原因', '结果', '关系',
    '父母', '孩子', '朋友', '同学', '老师', '学生', '医生', '护士', '警察', '司机',
    '今天', '明天', '昨天', '现在', '以前', '以后', '刚才', '马上', '经常', '偶尔',
    '非常', '特别', '十分', '比较', '更加', '最', '都', '也', '还', '又', '再',
    '因为', '所以', '如果', '虽然', '但是', '而且', '或者', '不过', '然后', '于是',
    '电话', '电脑', '手机', '电视', '冰箱', '空调', '汽车', '火车', '飞机', '公交',
    '学校', '医院', '银行', '商店', '超市', '餐厅', '公司', '工厂', '公园', '广场',
    '中国', '美国', '英国', '日本', '韩国', '法国', '德国', '世界', '国家', '城市',

    // 常用三字词
    '怎么样', '为什么', '没关系', '不好意思', '对不起', '没问题', '不一定', '差不多',
    '图书馆', '博物馆', '电影院', '游泳池', '体育馆', '飞机场', '火车站', '公交车',
    '洗手间', '办公室', '会议室', '停车场', '加油站', '派出所', '幼儿园', '小学生',
    '服务员', '营业员', '售货员', '收银员', '快递员', '外卖员', '志愿者', '工程师',
    '计算机', '互联网', '人工智能', '机器学习', '大数据', '云计算', '物联网',

    // 常用四字词/成语
    '没有关系', '不好意思', '各种各样', '越来越', '一点儿', '有一点', '一会儿',

    // HSK 高频词汇补充
    '帮助', '参加', '成为', '出现', '打算', '发现', '发展', '改变', '感觉', '感谢',
    '关心', '害怕', '回忆', '获得', '记得', '记住', '坚持', '建议', '交流', '接受',
    '解决', '介绍', '进步', '经过', '经历', '决定', '考虑', '离开', '理解', '联系',
    '练习', '满足', '努力', '判断', '批评', '期待', '适合', '使用', '提高', '提供',
    '讨论', '同意', '完成', '忘记', '希望', '相信', '想象', '消失', '选择', '研究',
    '要求', '影响', '拥有', '遇到', '原谅', '照顾', '支持', '重视', '准备', '尊重',
    '注意', '组织', '表示', '表现', '表演', '保护', '保持', '保证', '报名', '比较',
    '毕业', '避免', '变化', '表达', '补充', '采访', '参观', '尝试', '承认', '出发',
    '出生', '处理', '创造', '打扫', '担心', '导致', '道歉', '得到', '等待', '独立',
    '翻译', '反对', '反映', '访问', '放弃', '放松', '分别', '丰富', '符合', '负责',
    '复习', '改革', '改善', '感受', '告别', '根据', '公布', '购物', '鼓励', '广播',
    '规定', '合作', '后悔', '忽然', '忽视', '怀疑', '欢迎', '回复', '继续', '加班',
    '加强', '检查', '减少', '建立', '建设', '降低', '教育', '接待', '接近', '节省',
    '节约', '结合', '结婚', '结束', '解释', '借', '禁止', '惊讶', '竞争', '拒绝',
    '聚会', '开发', '开放', '开始', '开展', '肯定', '控制', '扩大', '劳动', '离婚',
    '利用', '连接', '联合', '聊天', '流行', '满意', '面对', '面临', '描述', '命令',
    '模仿', '难受', '能够', '暖和', '培训', '培养', '评价', '破坏', '起飞', '抢',
    '请客', '请求', '庆祝', '取消', '缺乏', '缺少', '确定', '确认', '热爱', '热情',
    '认为', '仍然', '融合', '伤害', '商量', '上升', '设计', '申请', '生产', '失去',
    '失望', '实践', '实现', '实行', '适应', '收获', '收集', '受伤', '输入', '属于',
    '说明', '讨厌', '提倡', '提前', '提问', '调查', '调整', '听说', '通知', '同情',
    '统一', '投资', '突然', '推动', '推广', '推荐', '退休', '完善', '危害', '违反',
    '围绕', '维持', '维护', '温度', '问候', '吸收', '吸引', '习惯', '洗澡', '吓',
    '显然', '显示', '限制', '羡慕', '相处', '相当', '相反', '享受', '想念', '消费',
    '消息', '效率', '笑话', '写作', '形成', '形容', '形式', '形象', '行动', '行为',
    '幸运', '修改', '需要', '宣布', '宣传', '寻找', '询问', '训练', '压力', '延长',
    '严肃', '演出', '验证', '养成', '邀请', '依靠', '依然', '移动', '引导', '引起',
    '印象', '应付', '应用', '迎接', '营业', '赢得', '拥抱', '拥挤', '永远', '优秀',
    '由于', '有利', '愉快', '预报', '预防', '预算', '预习', '愿意', '运动', '运输',
    '运用', '允许', '增加', '增长', '展开', '展示', '战斗', '战争', '掌握', '招待',
    '招呼', '着急', '真正', '争论', '争取', '证明', '支付', '指导', '指挥', '指示',
    '制定', '制造', '中断', '主张', '祝愿', '抓紧', '专心', '转变', '转告', '装修',
    '追求', '资助', '自动', '自觉', '自信', '总结', '阻止', '遵守', '作为',

    // 常用名词
    '比赛', '城市', '成功', '成就', '传统', '春天', '答案', '地方', '地球', '冬天',
    '动物', '方法', '方面', '方向', '感情', '故事', '关键', '观点', '广告', '国家',
    '过程', '行业', '环境', '活动', '机会', '计划', '技术', '价格', '健康', '教育',
    '结果', '经济', '经验', '困难', '历史', '力量', '礼物', '理想', '邻居', '旅行',
    '目的', '目标', '内容', '能力', '年龄', '农村', '气候', '情况', '秋天', '人们',
    '人生', '社会', '生命', '时间', '世界', '市场', '事情', '数据', '水平', '思想',
    '速度', '特点', '条件', '网络', '未来', '文化', '夏天', '效果', '信息', '幸福',
    '性格', '颜色', '样子', '艺术', '意思', '意见', '音乐', '原因', '责任', '知识',
    '职业', '质量', '自然', '作家', '作品', '标准', '基础', '规模', '规则', '精神',
    '角度', '权力', '权利', '缺点', '优点', '人才', '身份', '事业', '态度', '特征',
    '痛苦', '投资', '途径', '网站', '危机', '文明', '系统', '现象', '项目', '效率',
    '信念', '学科', '优势', '原理', '原则', '战略', '障碍', '政策', '证据', '制度',
    '智慧', '资源', '资本',

    // 形容词
    '安静', '安全', '抱歉', '必须', '不同', '诚实', '聪明', '当然', '独立', '方便',
    '丰富', '复杂', '干净', '感动', '各种', '公平', '孤独', '广泛', '国际', '合适',
    '积极', '紧张', '精彩', '具体', '开心', '可爱', '可怜', '勇敢', '浪漫', '厉害',
    '美丽', '免费', '明显', '耐心', '难过', '偶然', '普通', '奇怪', '清楚', '穷',
    '确实', '热情', '认真', '伤心', '生气', '实际', '舒服', '顺利', '特别', '突然',
    '温暖', '无聊', '详细', '辛苦', '新鲜', '幸运', '严格', '严重', '一般', '一样',
    '有趣', '自由', '专业', '准确', '仔细', '悲观', '必要', '彻底', '诚恳', '抽象',
    '大胆', '单纯', '繁荣', '敏感', '明确', '模糊', '朴素', '谦虚', '强烈', '全面',
    '深刻', '适当', '私人', '透明', '稳定', '显著', '先进', '相对', '相关', '有效',
    '真诚', '正常', '重大', '周到', '专门', '自愿', '综合', '重要', '简单', '容易',
    '困难', '危险'
]);

// ============================================
// 常用字频率表（用于识别不常用字）
// ============================================
const COMMON_CHARS = new Set('的一是不了在人有我他这个们中来上大为和国地到以说时要就出会可也你对生能而子那得于着下自之年过发后作里如果样多没成她好小日因又用从自己只年最方面前所本见经头面起日电回分却向问想利战使情间已每全系当话重新开十没方情经第且起三现事法实其几公平明什总加阿已得不然也力又使已其事心间动少同老条十方或第且起三现东部民中于长发可问着并无应国些说路样动加美文已第体产电边员结知道向反原月光因先定条动者最安便还最及管内外带高许基应却些分过化即理给气无民又应要内总前经比带处知道最使许相当建力提真正却相当各常水当道系理等区业员取重话更实能点然设路边面几程间原设更加便新对方理定处业相重意比起及各见便务给等间关原实应心提设道要面则期处员当报使边见常面关无说原进点通根相与通更部即原放己给处关边提特面指结使开反次总放几期几表反根员边原加几全表示');

/**
 * 判断是否为有效的中文词汇
 */
function isValidWord(word) {
    // 首先检查是否在词汇表中
    if (VALID_WORDS.has(word)) return true;
    if (VOCABULARY_DATABASE[word]) return true;

    return false;
}

/**
 * 判断一个字符是否为汉字
 */
function isChinese(char) {
    return /[\u4e00-\u9fa5]/.test(char);
}

/**
 * 判断一个字是否为常用字
 */
function isCommonChar(char) {
    return COMMON_CHARS.has(char);
}

/**
 * 根据等级设置判断哪些词应该被识别为生词
 */
function shouldBeVocab(word, level) {
    // 检查词中是否包含不常用字
    const hasUncommonChar = [...word].some(c => isChinese(c) && !isCommonChar(c));

    switch (level) {
        case '初级':
            // 初级：大部分多字词都是生词
            return true;
        case '中级':
            // 中级：需要包含不常用字或者词较长
            return hasUncommonChar || word.length >= 3;
        case '高级':
            // 高级：只有包含不常用字的词
            return hasUncommonChar;
        default:
            return true;
    }
}

/**
 * 智能识别文章中的生词
 * @param {string} content 文章内容
 * @param {string} level 文章等级：初级/中级/高级
 * @returns {Array} 生词列表
 */
export function autoDetectVocabulary(content, level) {
    const vocabulary = [];
    const addedWords = new Set();

    // 获取所有已知词汇，按长度排序（长词优先匹配）
    const allKnownWords = [...VALID_WORDS, ...Object.keys(VOCABULARY_DATABASE)];
    const sortedWords = [...new Set(allKnownWords)].sort((a, b) => b.length - a.length);

    // 遍历所有已知词汇，检查是否在文章中出现
    for (const word of sortedWords) {
        if (word.length < 2) continue; // 跳过单字
        if (addedWords.has(word)) continue;

        // 检查词是否在文章中出现
        if (content.includes(word)) {
            // 根据难度等级判断是否应该作为生词
            if (shouldBeVocab(word, level)) {
                const data = VOCABULARY_DATABASE[word];
                vocabulary.push({
                    word,
                    pinyin: data?.pinyin || '',
                    en: data?.en || '',
                    cn: data?.cn || ''
                });
                addedWords.add(word);
            }
        }
    }

    // 限制生词数量
    const maxWords = level === '初级' ? 12 : level === '中级' ? 15 : 18;

    // 优先显示有释义的词
    vocabulary.sort((a, b) => {
        const aHasDef = a.pinyin && a.en ? 1 : 0;
        const bHasDef = b.pinyin && b.en ? 1 : 0;
        if (bHasDef !== aHasDef) return bHasDef - aHasDef;
        return b.word.length - a.word.length;
    });

    return vocabulary.slice(0, maxWords);
}

/**
 * 获取词汇释义（如果已知）
 */
export function getWordDefinition(word) {
    return VOCABULARY_DATABASE[word] || null;
}

/**
 * 分析文章难度
 */
export function analyzeArticleDifficulty(content) {
    const chars = [...content].filter(isChinese);
    if (chars.length === 0) return { level: '初级', stats: {} };

    const uncommonCount = chars.filter(c => !isCommonChar(c)).length;
    const ratio = uncommonCount / chars.length;

    let suggestedLevel = '初级';
    if (ratio < 0.05) {
        suggestedLevel = '初级';
    } else if (ratio < 0.15) {
        suggestedLevel = '中级';
    } else {
        suggestedLevel = '高级';
    }

    return {
        level: suggestedLevel,
        stats: {
            totalChars: chars.length,
            uncommonChars: uncommonCount,
            ratio: (ratio * 100).toFixed(1) + '%'
        }
    };
}

// 导出释义库供其他模块使用
export { VOCABULARY_DATABASE };
